<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebXR - Usando ARButton</title> <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        canvas { display: block; }
        /* ARButton crea su propio estilo, pero podemos añadir algo si queremos */
        #ARButton { /* ID por defecto que usa ARButton */
             position: absolute;
             bottom: 20px;
             right: 20px;
             padding: 12px;
             border: none;
             border-radius: 4px;
             background: rgba(0, 0, 0, 0.6);
             color: white;
             font-weight: bold;
             cursor: pointer;
             z-index: 999;
        }
        #ARButton:hover {
             background: rgba(0, 0, 0, 0.8);
        }
        #ARButton:disabled {
             cursor: default;
             opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gray-100">
    <script type="module">
        // Importar componentes necesarios de Three.js
        import {
            Scene, PerspectiveCamera, WebGLRenderer, AmbientLight, DirectionalLight,
            AxesHelper
        } from 'three';
        // Importar ARButton
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        console.log("Script (módulo) iniciado.");

        // Variables globales
        let scene, camera, renderer;
        let controller1; // Mando derecho

        // Ya no necesitamos: xrSession, xrRefSpace, xrButton, messageDiv

        // --- Función para mostrar mensajes (la dejamos por si acaso para errores futuros) ---
        function showMessage(msg, isError = false) {
              console.log(`Mensaje UI (simulado): ${msg}`, isError ? "(ERROR)" : "");
              // Podríamos crear un div temporal si fuera necesario mostrar errores
              if(isError) {
                  alert("Error: " + msg); // Simple alerta para errores críticos
              }
        }

        // --- Inicializar Three.js y Configuración XR ---
        function initThree() {
             try {
                console.log("Iniciando Three.js v0.163.0...");
                //showMessage("Iniciando Three.js...", false); // ARButton da feedback
                scene = new Scene();

                const axesHelper = new AxesHelper( 2 );
                scene.add( axesHelper );

                camera = new PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                // La posición inicial de la cámara es menos relevante con ARButton/WebXR
                // camera.position.set(0, 1.6, 5.0);
                // camera.lookAt(0, 1, 0);

                renderer = new WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.xr.enabled = true; // Habilitar WebXR ANTES de crear ARButton
                document.body.appendChild(renderer.domElement);
                console.log("Renderer añadido al DOM.");

                // --- Crear y añadir ARButton ---
                // ARButton se encarga de verificar compatibilidad y manejar sesiones
                // Podemos pasarle opciones de sesión si queremos
                const button = ARButton.createButton(renderer, {
                     requiredFeatures: ['local-floor'] // Intentar pedir 'local-floor'
                     // Opciones adicionales como 'domOverlay' podrían ir aquí
                });
                document.body.appendChild(button); // Añadir el botón creado al DOM
                console.log("ARButton añadido.");
                // Ya no llamamos a checkXRSupport manualmente

                // --- Luces ---
                const ambientLight = new AmbientLight(0xffffff, 0.8);
                scene.add(ambientLight);
                const directionalLight = new DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(1, 2, 1).normalize();
                scene.add(directionalLight);

                // --- Configurar Mandos (Mínimo) ---
                setupControllersMinimal();

                // --- Carga de Modelo Comentada ---
                console.log("Carga de modelo FBX OMITIDA para depuración.");
                // showMessage("Modelo omitido (debug). Escena lista.", false);

                // Iniciar bucle de renderizado
                renderer.setAnimationLoop(renderLoop);
                console.log("Bucle de animación iniciado.");
                return true;

            } catch (error) {
                console.error("Error fatal al inicializar Three.js:", error);
                showMessage(`Error CRÍTICO en Three.js: ${error.message}`, true);
                return false;
            }
        }

        // --- Configuración de Mandos Mínima ---
        function setupControllersMinimal() {
            // Mando Derecho (índice 1)
            // Es importante obtenerlo aquí para que esté disponible
            controller1 = renderer.xr.getController(1);
            scene.add(controller1);
            console.log("Mandos configurados (mínimo).");
            // Listeners y visualización se añadirán después si esto funciona
        }

        // --- Bucle de Renderizado ---
        function renderLoop(timestamp, frame) {
            // frame es proporcionado por WebXR cuando está en sesión
            // Podemos usarlo para lógica más avanzada si es necesario

            // Renderizar la escena
            if (renderer && scene && camera) {
                 renderer.render(scene, camera);
            }
        }

        // --- Funciones WebXR Manuales Eliminadas ---
        // checkXRSupport, startXRSession, onSessionEnded, endXRSession

        // --- Inicio de la Aplicación ---
        document.addEventListener('DOMContentLoaded', () => {
              console.log("Evento DOMContentLoaded recibido.");
             initThree();

             // Listener de redimensionado
             window.addEventListener('resize', () => {
                 // Solo redimensionar si NO estamos en sesión XR
                 if (renderer && camera && !renderer.xr.isPresenting) {
                     camera.aspect = window.innerWidth / window.innerHeight;
                     camera.updateProjectionMatrix();
                     renderer.setSize(window.innerWidth, window.innerHeight);
                      console.log("Renderer redimensionado.");
                 }
            });
        });

        console.log("Fin del script (módulo) principal.");

    </script>
</body>
</html>




