<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR con Modelo 3D (FBX) e Interacción</title> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/fflate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        #xr-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #4a90e2; /* Azul */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        #xr-button:hover {
            background-color: #357abd;
        }
        #xr-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #message {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 5px;
            display: block;
            text-align: center;
            z-index: 10;
            max-width: 90%;
        }
        canvas { display: block; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="message">Cargando escena...</div>
    <button id="xr-button" disabled>Verificando compatibilidad...</button>

    <script>
        console.log("Script iniciado.");
        // Variables globales
        let scene, camera, renderer;
        let xrSession = null;
        let xrRefSpace = null;
        let loadedModel = null;
        let modelBoxHelper = null;

        // Variables para Interacción con Mandos
        let controller1; // Mando derecho
        let raycaster;
        let intersectedObject = null; // Objeto actualmente agarrado

        const xrButton = document.getElementById('xr-button');
        const messageDiv = document.getElementById('message');

        // --- Función para mostrar mensajes ---
        function showMessage(msg, isError = false) {
             // ... (código idéntico) ...
             if (messageDiv) {
                messageDiv.textContent = msg;
                messageDiv.style.color = isError ? '#FFCCCC' : 'white';
                messageDiv.style.backgroundColor = isError ? 'rgba(150, 0, 0, 0.8)' : 'rgba(0, 0, 0, 0.7)';
                messageDiv.style.display = 'block';
                console.log(`Mensaje UI: ${msg}`);
                if (!isError) {
                    setTimeout(() => {
                        if (messageDiv.textContent === msg && !isError) {
                             messageDiv.style.display = 'none';
                        }
                    }, 6000);
                }
            } else {
                console.error("Error: messageDiv no encontrado. Mensaje:", msg);
            }
        }

        // --- Inicializar Three.js y Configuración XR ---
        function initThree() {
             try {
                console.log("Iniciando Three.js...");
                showMessage("Iniciando Three.js...", false);
                scene = new THREE.Scene();

                const axesHelper = new THREE.AxesHelper( 2 );
                scene.add( axesHelper );

                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 1.6, 5.0);
                camera.lookAt(0, 1, 0);

                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.xr.enabled = true; // Habilitar WebXR
                document.body.appendChild(renderer.domElement);
                console.log("Renderer añadido al DOM.");

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(1, 2, 1).normalize();
                scene.add(directionalLight);

                // --- Configurar Mandos ---
                setupControllers();

                // --- Cargar Modelo ---
                loadFBXModel(); // Esta función ahora también llama a checkXRSupport al terminar

                // Iniciar bucle de renderizado
                renderer.setAnimationLoop(renderLoop);
                console.log("Bucle de animación iniciado.");
                return true;

            } catch (error) {
                console.error("Error fatal al inicializar Three.js:", error);
                showMessage(`Error CRÍTICO en Three.js: ${error.message}`, true);
                 if(xrButton) {
                    xrButton.disabled = true;
                    xrButton.textContent = "Error de inicialización";
                 }
                return false;
            }
        }

        // --- Configuración de Mandos y Raycaster ---
        function setupControllers() {
            // Mando Derecho (índice 1)
            controller1 = renderer.xr.getController(1);
            scene.add(controller1); // Añadir el mando a la escena para que se actualice su posición

            // Añadir listeners para eventos de selección (agarrar/soltar)
            controller1.addEventListener('selectstart', onSelectStart);
            controller1.addEventListener('selectend', onSelectEnd);

            // (Opcional) Añadir una línea visual al mando para saber hacia dónde apunta
            const controllerMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 }); // Línea blanca
            const controllerGeometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0), // Origen del mando
                new THREE.Vector3(0, 0, -1) // Línea apuntando hacia adelante (1 metro)
            ]);
            const controllerLine = new THREE.Line(controllerGeometry, controllerMaterial);
            controllerLine.scale.z = 0.5; // Hacer la línea más corta (0.5 metros)
            controller1.add(controllerLine); // Añadir la línea como hija del mando

            // Crear el Raycaster
            raycaster = new THREE.Raycaster();

            console.log("Mandos configurados.");
        }

        // --- Función para Cargar el Modelo FBX ---
        function loadFBXModel() {
              if (typeof THREE.FBXLoader === 'undefined') {
                 console.error("THREE.FBXLoader no está definido.");
                 showMessage("Error: Falta FBXLoader.", true);
                 return;
            }

            const loader = new THREE.FBXLoader();
            const modelUrl = 'planta_interior_2.fbx';

            console.log(`Intentando cargar modelo FBX desde: ${modelUrl}`);
            showMessage(`Cargando modelo FBX: ${modelUrl}...`, false);

            loader.load(
                modelUrl,
                function (object) {
                    console.log("Modelo FBX cargado correctamente:", object);
                    loadedModel = object;

                    loadedModel.scale.set(0.001, 0.001, 0.001);
                    loadedModel.position.set(0, 1.0, -1.5);

                    // Comentado el override de material, usar materiales originales
                    /*
                    const overrideMaterial = new THREE.MeshBasicMaterial({...});
                    loadedModel.traverse(...);
                    */

                     loadedModel.traverse(function (child) {
                         if (child.isMesh) {
                             child.castShadow = true;
                             child.receiveShadow = true;
                         }
                     });

                    scene.add(loadedModel);
                    console.log("Modelo FBX añadido a la escena.");

                    // Añadir BoxHelper (útil mantenerlo)
                    if (modelBoxHelper) scene.remove(modelBoxHelper);
                    modelBoxHelper = new THREE.BoxHelper( loadedModel, 0xffff00 );
                    scene.add( modelBoxHelper );
                    console.log("BoxHelper añadido/actualizado para el modelo.");

                    showMessage("Modelo FBX cargado. Escena lista.", false);
                    checkXRSupport(); // Verificar WebXR después de cargar
                },
                function (xhr) { /* ... onProgress idéntico ... */
                    const percentLoaded = (xhr.loaded / xhr.total * 100).toFixed(0);
                    console.log(`Modelo FBX ${percentLoaded}% cargado`);
                    if (percentLoaded < 100) {
                        showMessage(`Cargando modelo FBX: ${percentLoaded}%`, false);
                    }
                 },
                function (error) { /* ... onError idéntico ... */
                     console.error("Error al cargar el modelo FBX:", error);
                    let errorMsg = `Error al cargar modelo FBX: ${modelUrl}. `;
                    if (error.target && error.target.status === 0) {
                        errorMsg += 'Posible error de CORS o red.';
                    } else if (error.target && error.target.status === 404) {
                        errorMsg += 'Error 404 (No encontrado). Verifica la URL.';
                    } else {
                        errorMsg += error.message ? error.message : '(Ver consola para detalles)';
                    }
                    showMessage(errorMsg, true);
                     checkXRSupport();
                }
            );
        }

        // --- Manejadores de Eventos de Selección del Mando ---

        function onSelectStart(event) {
            console.log("SelectStart detectado");
            const controller = event.target; // El mando que disparó el evento

            if (!loadedModel) return; // No hacer nada si el modelo no ha cargado

            // Crear una matriz temporal para la posición/orientación del mando
            const tempMatrix = new THREE.Matrix4();
            tempMatrix.identity().extractRotation(controller.matrixWorld); // Obtener rotación del mando

            // Establecer origen y dirección del rayo desde el mando
            raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld); // Origen en la posición del mando
            raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix); // Dirección: hacia adelante (Z negativo) relativo al mando

            // Comprobar intersecciones con el modelo cargado (y sus hijos)
            const intersects = raycaster.intersectObject(loadedModel, true); // El 'true' es para recursividad

            if (intersects.length > 0) {
                console.log("Intersección encontrada con el modelo!");
                intersectedObject = loadedModel; // Guardar referencia al objeto agarrado

                // Adjuntar el modelo al mando
                // Three.js se encarga de mantener la posición relativa inicial
                controller.attach(intersectedObject);
                console.log("Modelo adjuntado al mando.");

                // (Opcional) Ocultar BoxHelper mientras se agarra
                if (modelBoxHelper) modelBoxHelper.visible = false;

            } else {
                console.log("No se encontró intersección con el modelo.");
            }
        }

        function onSelectEnd(event) {
            console.log("SelectEnd detectado");
            if (intersectedObject) {
                console.log("Soltando el modelo...");
                // Readjuntar el objeto a la escena principal
                // scene.attach se encarga de mantener la transformación global
                scene.attach(intersectedObject);
                console.log("Modelo readjuntado a la escena.");

                // Limpiar la referencia
                intersectedObject = null;

                // (Opcional) Volver a mostrar BoxHelper
                 if (modelBoxHelper) modelBoxHelper.visible = true;
            }
        }


        // --- Bucle de Renderizado ---
        function renderLoop(timestamp, frame) {
            // Actualizar el BoxHelper si existe y es visible
            if (modelBoxHelper && modelBoxHelper.visible) {
                modelBoxHelper.update();
            }

            // Renderizar la escena
            if (renderer && scene && camera) {
                 renderer.render(scene, camera);
            }
        }

        // --- Funciones WebXR (checkXRSupport, startXRSession, onSessionEnded, endXRSession) ---
        // (Sin cambios)
        async function checkXRSupport() { /* ... código idéntico ... */
             console.log("--- Iniciando checkXRSupport ---");
            const currentMsg = messageDiv.textContent;
            const showCheckMsg = !currentMsg.includes('Error') && !currentMsg.includes('cargado');

            if (showCheckMsg) {
                 showMessage("Verificando compatibilidad WebXR...", false);
            }

            if (navigator.xr) {
                console.log("navigator.xr existe.");
                try {
                    console.log("Intentando navigator.xr.isSessionSupported('immersive-ar')...");
                    const supported = await navigator.xr.isSessionSupported('immersive-ar');
                    console.log(`isSessionSupported('immersive-ar') devolvió: ${supported}`);
                    if (supported) {
                        xrButton.disabled = false;
                        xrButton.textContent = 'Iniciar Realidad Mixta';
                        xrButton.onclick = startXRSession;
                         if (showCheckMsg) {
                            showMessage("WebXR 'immersive-ar' compatible. ¡Listo!", false);
                         }
                    } else {
                         if (!messageDiv.textContent.startsWith('Error al cargar')) {
                            showMessage("El modo 'immersive-ar' no es compatible.", true);
                         }
                        xrButton.disabled = true;
                        xrButton.textContent = "Modo AR no soportado";
                    }
                } catch (error) {
                    console.error("Error dentro de isSessionSupported:", error);
                    showMessage(`Error al comprobar compatibilidad: ${error.message}`, true);
                    xrButton.disabled = true;
                    xrButton.textContent = "Error de compatibilidad";
                }
            } else {
                console.log("navigator.xr NO existe.");
                showMessage("WebXR no es compatible con este navegador.", true);
                xrButton.disabled = true;
                xrButton.textContent = "WebXR no soportado";
            }
             console.log("--- Finalizando checkXRSupport ---");
        }
        async function startXRSession() { /* ... código idéntico ... */
              console.log("Intentando iniciar sesión XR...");
            showMessage("Iniciando sesión XR...", false);
            xrButton.disabled = true;
            xrButton.textContent = "Iniciando...";

            if (!xrSession) {
                try {
                    console.log("Solicitando sesión 'immersive-ar'...");
                    xrSession = await navigator.xr.requestSession('immersive-ar', {
                         requiredFeatures: ['local-floor']
                    });
                    console.log("Sesión XR obtenida:", xrSession);

                    console.log("Configurando capa base de WebGL...");
                    await renderer.xr.setSession(xrSession);
                    console.log("Sesión asignada al renderer XR.");

                    console.log("Solicitando espacio de referencia 'local-floor'...");
                    xrRefSpace = await xrSession.requestReferenceSpace('local-floor');
                    console.log("Espacio de referencia 'local-floor' obtenido.");


                    xrButton.textContent = 'Salir de Realidad Mixta';
                    xrButton.onclick = endXRSession;
                    xrButton.disabled = false;

                    messageDiv.style.display = 'none';
                     console.log("¡Sesión XR iniciada correctamente!");

                    xrSession.addEventListener('end', onSessionEnded);

                } catch (error) {
                    console.error("Error al iniciar la sesión WebXR:", error);
                    showMessage(`Error al iniciar la sesión: ${error.message}`, true);
                    xrSession = null;
                    xrButton.textContent = 'Iniciar Realidad Mixta';
                    xrButton.onclick = startXRSession;
                    checkXRSupport();
                }
            }
        }
        function onSessionEnded() { /* ... código idéntico ... */
               console.log("Evento 'sessionended' recibido.");
            if (xrSession) {
                xrSession.removeEventListener('end', onSessionEnded);
                xrSession = null;
            }
            if (renderer && renderer.xr) {
                 renderer.xr.setSession(null);
            }
            xrButton.textContent = 'Iniciar Realidad Mixta';
            xrButton.onclick = startXRSession;
            checkXRSupport();
            showMessage("Sesión de Realidad Mixta terminada.", false);
             if (camera) {
                camera.position.set(0, 1.6, 5.0); // Restaurar posición Z de cámara alejada
                camera.lookAt(0, 1, 0);
             }
        }
        async function endXRSession() { /* ... código idéntico ... */
               console.log("Intentando terminar la sesión XR manualmente...");
             xrButton.disabled = true;
             xrButton.textContent = "Saliendo...";
            if (xrSession) {
                try {
                    await xrSession.end();
                    console.log("Llamada a xrSession.end() completada.");
                } catch (error) {
                    console.error("Error al terminar la sesión WebXR:", error);
                    showMessage(`Error al salir de la sesión: ${error.message}`, true);
                    onSessionEnded();
                }
            } else {
                 console.warn("Se intentó llamar a endXRSession sin una sesión activa.");
                 onSessionEnded();
            }
        }


        // --- Inicio de la Aplicación ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... (código idéntico) ...
                console.log("Evento DOMContentLoaded recibido.");
            showMessage("DOM cargado. Inicializando Three.js...", false);

             if (typeof THREE === 'undefined') {
                 console.error("¡Error Crítico! THREE no está definido.");
                 showMessage("Error CRÍTICO: No se pudo cargar Three.js.", true);
                 return;
             }

            initThree();

            window.addEventListener('resize', () => {
                 if (renderer && camera && !renderer.xr.isPresenting) {
                     camera.aspect = window.innerWidth / window.innerHeight;
                     camera.updateProjectionMatrix();
                     renderer.setSize(window.innerWidth, window.innerHeight);
                      console.log("Renderer redimensionado.");
                 }
            });
        });

        console.log("Fin del script principal.");

    </script>
</body>
</html>













