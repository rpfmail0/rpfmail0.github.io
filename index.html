<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebXR Passthrough - Cubo Flotante</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        canvas { display: block; }
        /* El ARButton se posiciona automáticamente, pero podemos ajustar si es necesario */
        #ar-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 999;
        }
    </style>
</head>
<body>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        // ***** CAMBIO: Importar ARButton en lugar de VRButton *****
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        let camera, scene, renderer;
        let cube;

        // Función de inicialización
        function init() {
            // Crear escena
            scene = new THREE.Scene();
            // ***** CAMBIO: Fondo nulo para permitir passthrough *****
            // Ya no establecemos un color de fondo para la escena.
            // scene.background = new THREE.Color(0x505050); // <- Línea eliminada/comentada

            // Crear cámara (para la vista no-AR/VR inicial)
            // Sigue siendo útil para la vista previa 2D antes de entrar en AR.
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 3); // Posición inicial arbitraria para vista 2D

            // Crear renderer WebGL
            // ***** CAMBIO: Habilitar alpha para transparencia *****
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true // <-- Necesario para que el canvas sea transparente
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // ***** CAMBIO: Establecer alfa de limpieza a 0 *****
            // Asegura que el fondo del canvas sea completamente transparente.
            renderer.setClearAlpha(0);

            document.body.appendChild(renderer.domElement);

            // Habilitar WebXR (necesario para AR también)
            renderer.xr.enabled = true;

            // ***** CAMBIO: Añadir ARButton *****
            // ARButton solicitará una sesión 'immersive-ar' que habilita passthrough si está disponible.
            const arButton = ARButton.createButton(renderer, {
                // Opcional: Puedes requerir características aquí si es necesario,
                // pero ARButton suele pedir 'local-floor' por defecto.
                // requiredFeatures: ['local-floor']
            });
            arButton.id = 'ar-button'; // Asignar ID para CSS
            document.body.appendChild(arButton);


            // --- Crear el Cubo ---
            // La creación y posicionamiento del cubo no cambian.
            const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5); // Un poco más pequeño quizás
            const material = new THREE.MeshStandardMaterial({
                color: 0x00ff00, // Verde
                roughness: 0.7,
                metalness: 0.1
             });
            cube = new THREE.Mesh(geometry, material);

            // Posicionar el cubo frente al origen (0,0,0) del espacio AR.
            // (0, 1.6, -2) -> Aprox. altura ojos, 2m delante. Ajusta según necesites.
            cube.position.set(0, 1.6, -2);
            scene.add(cube);

            // --- Añadir Luces ---
            // Las luces siguen siendo importantes para iluminar el cubo virtual.
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5); // Luz ambiental más brillante
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 2.0); // Luz direccional más intensa
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);

            // --- Eventos ---
            window.addEventListener('resize', onWindowResize);

            // Iniciar el bucle de animación/renderizado
            renderer.setAnimationLoop(animate);
        }

        // Función para manejar el redimensionamiento de la ventana
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Bucle de animación
        function animate() {
            // Rotar el cubo en cada frame
            cube.rotation.x += 0.01;
            cube.rotation.y += 0.01;

            // Renderizar la escena. Three.js usa la cámara XR correcta (VR o AR) automáticamente.
            renderer.render(scene, camera);
        }

        // Iniciar todo cuando la página cargue
        init();

    </script>
</body>
</html>
