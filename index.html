<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebXR Passthrough - Debugging Mover Cubo</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        canvas { display: block; }
        #ar-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 999;
        }
    </style>
</head>
<body>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        let camera, scene, renderer;
        let cube;
        let controller1, controller2;
        let raycaster;
        const intersected = []; // Reutilizar este array (aunque no se use directamente ahora)
        let tempMatrix = new THREE.Matrix4();
        let grabbingController = null;
        let grabbedObject = null;

        init();

        function init() {
            console.log("Iniciando escena..."); // DEBUG
            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 3);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearAlpha(0);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            const arButton = ARButton.createButton(renderer);
            arButton.id = 'ar-button';
            document.body.appendChild(arButton);

            // --- Crear el Cubo ---
            const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
            const material = new THREE.MeshStandardMaterial({
                color: 0x00ffff, // Cian
                roughness: 0.7,
                metalness: 0.1
             });
            cube = new THREE.Mesh(geometry, material);
            cube.position.set(0, 1.6, -1.5);
            scene.add(cube);

            // --- Añadir Luces ---
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 2.0);
            directionalLight.position.set(1, 1, 1).normalize();
            scene.add(directionalLight);

            // --- Configuración de Mandos ---
            controller1 = renderer.xr.getController(0);
            controller1.addEventListener('selectstart', onSelectStart);
            controller1.addEventListener('selectend', onSelectEnd);
            scene.add(controller1);
            console.log("Mando 1 añadido a escena y listeners configurados."); // DEBUG

            controller2 = renderer.xr.getController(1);
            controller2.addEventListener('selectstart', onSelectStart);
            controller2.addEventListener('selectend', onSelectEnd);
            scene.add(controller2);
            console.log("Mando 2 añadido a escena y listeners configurados."); // DEBUG

            // ***** NUEVO: Añadir visualización básica a los mandos *****
            // Una línea simple apuntando hacia adelante desde cada mando
            const controllerMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, linewidth: 2 }); // Línea blanca
            const controllerGeometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(0, 0, 0), // Origen en el mando
                new THREE.Vector3(0, 0, -0.5) // Línea de 50cm hacia adelante (-Z local)
            ]);

            const line1 = new THREE.Line(controllerGeometry, controllerMaterial);
            controller1.add(line1); // Añadir línea como hija del mando 1
            console.log("Visualización añadida al mando 1."); // DEBUG

            const line2 = new THREE.Line(controllerGeometry.clone(), controllerMaterial.clone()); // Usar geometría/material clonado
            controller2.add(line2); // Añadir línea como hija del mando 2
            console.log("Visualización añadida al mando 2."); // DEBUG


            // --- Configuración de Raycaster ---
            raycaster = new THREE.Raycaster();
            // Opcional: Configurar near/far del raycaster si sospechamos de distancias
            // raycaster.near = 0.1;
            // raycaster.far = 5; // Por ejemplo, solo detectar hasta 5 metros

            window.addEventListener('resize', onWindowResize);
            renderer.setAnimationLoop(animate);
            console.log("Inicialización completa, iniciando bucle de animación."); // DEBUG
        }

        function onSelectStart(event) {
            const controller = event.target;
            console.log("Evento: selectstart detectado en mando", controller === controller1 ? 1 : 2); // DEBUG

            if (grabbingController === controller) {
                console.log("DEBUG: Este mando ya está agarrando algo.");
                return;
            }

            tempMatrix.identity().extractRotation(controller.matrixWorld);
            raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
            raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);

            const intersects = raycaster.intersectObject(cube);
            console.log("DEBUG: Intersecciones encontradas:", intersects.length); // DEBUG

            if (intersects.length > 0) {
                console.log("DEBUG: ¡Intersección con el cubo!"); // DEBUG
                grabbedObject = intersects[0].object;
                controller.attach(grabbedObject); // Adjuntar al mando
                grabbingController = controller;
                console.log("DEBUG: Cubo agarrado por mando", controller === controller1 ? 1 : 2); // DEBUG
            } else {
                 console.log("DEBUG: No se encontró intersección con el cubo."); // DEBUG
            }
        }

        function onSelectEnd(event) {
            const controller = event.target;
            console.log("Evento: selectend detectado en mando", controller === controller1 ? 1 : 2); // DEBUG

            if (grabbingController === controller && grabbedObject) {
                console.log("DEBUG: Soltando el cubo desde el mando", controller === controller1 ? 1 : 2); // DEBUG
                scene.attach(grabbedObject); // Adjuntar a la escena
                grabbedObject = null;
                grabbingController = null;
            } else {
                 console.log("DEBUG: selectend pero no había nada agarrado por este mando."); // DEBUG
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            // No es necesario hacer nada específico con los mandos aquí para la interacción básica
            // Sus posiciones se actualizan automáticamente porque están en la escena.

            // Detener rotación si está agarrado
            if (!grabbingController) {
                 // cube.rotation.x += 0.01; // Desactivar rotación para simplificar debug
                 // cube.rotation.y += 0.01;
            }

            renderer.render(scene, camera);
        }

    </script>
</body>
</html>



