<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WebXR - Modelo FBX e Interacción con ARButton</title>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/",
                "fflate": "https://unpkg.com/fflate@0.8.1/esm/index.js" /* Añadido para FBXLoader */
            }
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        canvas { display: block; }
        #ARButton { /* Estilo para el botón de ARButton */
             position: absolute;
             bottom: 20px;
             right: 20px;
             padding: 12px;
             border: none;
             border-radius: 4px;
             background: rgba(0, 0, 0, 0.6);
             color: white;
             font-weight: bold;
             cursor: pointer;
             z-index: 999;
        }
        #ARButton:hover {
             background: rgba(0, 0, 0, 0.8);
        }
        #ARButton:disabled {
             cursor: default;
             opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gray-100">
    <script type="module">
        // Importaciones Principales
        import {
            Scene, PerspectiveCamera, WebGLRenderer, AmbientLight, DirectionalLight,
            AxesHelper, Raycaster, Vector3, Matrix4, LineBasicMaterial, BufferGeometry, Line,
            BoxHelper // Importar BoxHelper
        } from 'three';
        // Importar ARButton
        import { ARButton } from 'three/addons/webxr/ARButton.js';
        // Importar FBXLoader y dependencia fflate
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import * as fflate from 'fflate'; // Necesario para FBXLoader

        console.log("Script (módulo) iniciado.");

        // Variables globales
        let scene, camera, renderer;
        let controller1; // Mando derecho
        let raycaster;
        let tempMatrix = new THREE.Matrix4();
        let grabbingController = null;
        let grabbedObject = null;
        let loadedModel = null;
        let modelBoxHelper = null;

        // --- Función para mostrar mensajes (simple alerta para errores) ---
        function showMessage(msg, isError = false) {
              console.log(`Mensaje: ${msg}`, isError ? "(ERROR)" : "");
              if(isError) {
                  alert("Error: " + msg);
              }
        }

        // --- Inicializar Three.js y Configuración XR ---
        function initThree() {
             try {
                console.log("Iniciando Three.js v0.163.0...");
                scene = new Scene();

                const axesHelper = new AxesHelper( 2 );
                scene.add( axesHelper );

                camera = new PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

                renderer = new WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.xr.enabled = true;
                document.body.appendChild(renderer.domElement);
                console.log("Renderer añadido al DOM.");

                // --- Crear y añadir ARButton ---
                const button = ARButton.createButton(renderer, {
                     requiredFeatures: ['local-floor']
                });
                document.body.appendChild(button);
                console.log("ARButton añadido.");

                // --- Luces ---
                const ambientLight = new AmbientLight(0xffffff, 0.8);
                scene.add(ambientLight);
                const directionalLight = new DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(1, 2, 1).normalize();
                scene.add(directionalLight);

                // --- Configurar Mandos (con listeners y visualización) ---
                setupControllers();

                // --- Cargar Modelo FBX ---
                loadFBXModel();

                // Iniciar bucle de renderizado
                renderer.setAnimationLoop(renderLoop);
                console.log("Bucle de animación iniciado.");
                return true;

            } catch (error) {
                console.error("Error fatal al inicializar Three.js:", error);
                showMessage(`Error CRÍTICO en Three.js: ${error.message}`, true);
                return false;
            }
        }

         // --- Configuración de Mandos (Completa) ---
         function setupControllers() {
            // Mando Derecho (index 1)
            controller1 = renderer.xr.getController(1);
            controller1.addEventListener('selectstart', onSelectStart);
            controller1.addEventListener('selectend', onSelectEnd);
            scene.add(controller1);
            console.log("Mando 1 (Der) añadido y listeners configurados.");

            // Añadir visualización básica al mando derecho
            const controllerMaterial = new LineBasicMaterial({ color: 0xffffff, linewidth: 2 });
            const controllerGeometry = new BufferGeometry().setFromPoints([
                new Vector3(0, 0, 0),
                new Vector3(0, 0, -0.5) // Línea de 50cm
            ]);

            const line1 = new Line(controllerGeometry, controllerMaterial);
            controller1.add(line1);
            console.log("Visualización añadida al mando 1.");

            // Configurar Raycaster
            raycaster = new Raycaster();
            console.log("Raycaster configurado.");
        }

        // --- Cargar Modelo FBX ---
        function loadFBXModel() {
            const loader = new FBXLoader();
            // loader.setDecompressor(fflate); // Descomentar si hay problemas

            const modelUrl = 'planta_interior_2.fbx';
            console.log(`Intentando cargar modelo FBX desde: ${modelUrl}`);

            loader.load(
                modelUrl,
                // onLoad
                function (object) {
                    console.log("Modelo FBX cargado correctamente:", object);
                    loadedModel = object;

                    loadedModel.scale.set(0.001, 0.001, 0.001);
                    loadedModel.position.set(0, 1.0, -1.5);

                     loadedModel.traverse(function (child) {
                         if (child.isMesh) {
                             child.castShadow = true;
                             child.receiveShadow = true;
                         }
                     });

                    scene.add(loadedModel);
                    console.log("Modelo FBX añadido a la escena.");

                    if (modelBoxHelper) scene.remove(modelBoxHelper);
                    modelBoxHelper = new BoxHelper( loadedModel, 0xffff00 );
                    scene.add( modelBoxHelper );
                    console.log("BoxHelper añadido/actualizado para el modelo.");
                },
                // onProgress
                function (xhr) {
                    const percentLoaded = (xhr.loaded / xhr.total * 100).toFixed(0);
                    console.log(`Modelo FBX ${percentLoaded}% cargado`);
                },
                // onError
                function (error) {
                    console.error("Error al cargar el modelo FBX:", error);
                    showMessage(`Error al cargar modelo FBX: ${error.message || 'Ver consola'}`, true);
                }
            );
        }

        // --- Manejadores de Eventos de Selección ---
        function onSelectStart(event) {
            const controller = event.target;
            console.log("Evento: selectstart detectado");

            if (grabbingController) return;
            if (!loadedModel) return;

            tempMatrix.identity().extractRotation(controller.matrixWorld);
            raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
            raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);

            const intersects = raycaster.intersectObject(loadedModel, true);
            console.log("DEBUG: Intersecciones encontradas:", intersects.length);

            if (intersects.length > 0) {
                console.log("DEBUG: ¡Intersección con el modelo FBX!");
                grabbedObject = loadedModel;
                controller.attach(grabbedObject);
                grabbingController = controller;
                console.log("DEBUG: Modelo FBX agarrado.");
                if (modelBoxHelper) modelBoxHelper.visible = false;
            } else {
                 console.log("DEBUG: No se encontró intersección con el modelo FBX.");
            }
        }

        function onSelectEnd(event) {
            const controller = event.target;
            console.log("Evento: selectend detectado");

            if (grabbingController === controller && grabbedObject) {
                console.log("DEBUG: Soltando el modelo FBX.");
                scene.attach(grabbedObject);
                grabbedObject = null;
                grabbingController = null;
                if (modelBoxHelper) modelBoxHelper.visible = true;
            }
        }

        // --- Redimensionar Ventana ---
        function onWindowResize() {
            if (renderer && camera && !renderer.xr.isPresenting) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                 console.log("Renderer redimensionado.");
            }
        }

        // --- Bucle de Animación/Renderizado ---
        function animate(timestamp, frame) {
            if (modelBoxHelper && modelBoxHelper.visible) {
                modelBoxHelper.update();
            }
            renderer.render(scene, camera);
        }

        // --- Inicio de la Aplicación ---
        document.addEventListener('DOMContentLoaded', () => {
              console.log("Evento DOMContentLoaded recibido.");
             initThree();
             window.addEventListener('resize', onWindowResize);
        });

        console.log("Fin del script (módulo) principal.");

    </script>
</body>
</html>
